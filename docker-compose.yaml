version: '3.7'

services:
  nginx-mtls:
    build: .
    image: nginx:mtls-tcp
    container_name: nginx-mtls
    environment:
      - SERVER_CERT
      - SERVER_KEY
      - CLIENT_CA
      - PROXY_PROTOCOL
      - PROXY_URL
      - PROXY_PORT
      - RESOLVER
      - ECS_CONTAINER_METADATA_URI_V4
    restart: unless-stopped
    ports:
    - "8443:8443"
    - "8080:8080"
    # For debugging
    # volumes:
    #  - ./docker-entrypoint.d/40-write-certs.sh:/docker-entrypoint.d/40-write-certs.sh:ro
    #   - ./docker-entrypoint.d/50-get-dns.sh:/docker-entrypoint.d/50-get-dns.sh:ro
    #   - ./config/default.conf:/etc/nginx/nginx.conf:ro
    #   - ./config/templates/proxy-mtls.conf:/etc/nginx/templates/default.conf.template:ro
